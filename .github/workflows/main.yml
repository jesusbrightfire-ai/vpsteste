name: RDP

# Permiss√£o necess√°ria para que GITHUB_TOKEN dispare outros workflows
permissions:
  workflows: write

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # (seu conte√∫do original aqui ‚Äî mantenha igual ao que j√° funciona)
          Write-Host "Configuring RDP..." 

      # ... TODOS os steps do seu fluxo original permanecem aqui ...

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "==================`n"
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }

  auto-restart:
    needs: secure-rdp
    runs-on: ubuntu-latest
    steps:
      - name: Wait before restarting (test: 1 minute)
        run: |
          echo "‚è≥ Aguardando 60s antes de reiniciar (teste)..."
          sleep 60   # <- para teste: 60s. Para 5h30 use: sleep $((5*3600 + 30*60))  -> sleep 19800
      - name: Show what will be called
        run: |
          echo "Usando workflow file: main.yml"
          echo "Ref: main"
      - name: Trigger workflow_dispatch and print response
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Chamando API para dispatch do workflow (main.yml)..."
          # Mostra status HTTP e body para debug
          RESPONSE=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $TOKEN" \
            https://api.github.com/repos/$REPO/actions/workflows/main.yml/dispatches \
            -d '{"ref":"main"}' 2>&1) || true
          echo "curl retornou: $RESPONSE"
